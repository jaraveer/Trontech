// TRON dApp Configuration - LEGITIMATE USE ONLY
const WALLETCONNECT_PROJECT_ID = '69f2768993c07b7e24d7b7c42e316f16'; // Get from walletconnect.com
const USDT_TRC20_CONTRACT = 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t';

// State management
let signClient = null;
let currentSession = null;
let currentAddress = null;
let tronWeb = null;

// DOM Elements
const statusMessage = document.getElementById('status-message');
const loadingOverlay = document.getElementById('loading-overlay');
const loadingText = document.getElementById('loading-text');
const qrCodeContainer = document.getElementById('qr-code');

// Utility Functions
function showLoading(message) {
  loadingText.textContent = message;
  loadingOverlay.classList.remove('hidden');
}

function hideLoading() {
  loadingOverlay.classList.add('hidden');
}

function showStatus(message, type = 'info') {
  statusMessage.textContent = message;
  statusMessage.className = `status-message ${type}`;
  statusMessage.classList.remove('hidden');
  setTimeout(() => {
    statusMessage.classList.add('hidden');
  }, 5000);
}

// Initialize WalletConnect SignClient
async function initWalletConnect() {
  try {
    if (signClient) return signClient;

    showLoading('Initializing connection...');

    let attempts = 0;
    while (!window.SignClient && attempts < 50) {
      await new Promise(resolve => setTimeout(resolve, 100));
      attempts++;
    }

    if (!window.SignClient) {
      throw new Error('WalletConnect library not loaded');
    }

    const SignClient = window.SignClient;

    signClient = await SignClient.init({
      projectId: WALLETCONNECT_PROJECT_ID,
      metadata: {
        name: 'TronTech - TRON dApp',
        description: 'Legitimate TRON dApp for token interactions',
        url: 'https://trontech.shop',
        icons: ['https://trontech.shop/logo.png'] // Use your actual logo
      }
    });

    console.log('WalletConnect SignClient initialized');

    signClient.on('session_proposal', handleSessionProposal);
    signClient.on('session_event', handleSessionEvent);
    signClient.on('session_delete', handleSessionDelete);

    return signClient;
  } catch (error) {
    console.error('WalletConnect init error:', error);
    hideLoading();
    throw new Error('Failed to initialize WalletConnect: ' + error.message);
  }
}

// Connect with WalletConnect
async function connectWalletConnect() {
  try {
    showLoading('Connecting to your wallet...');

    const client = await initWalletConnect();

    const { uri, approval } = await client.connect({
      requiredNamespaces: {
        tron: {
          chains: ['tron:0x2b6653dc'],
          methods: ['tron_signTransaction', 'tron_signMessage'],
          events: ['accountsChanged', 'chainChanged']
        }
      }
    });

    if (!uri) {
      throw new Error('Failed to generate connection URI');
    }

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    if (isMobile) {
      const wcDeepLink = `wc:${uri.replace('wc:', '')}`;
      window.location.href = wcDeepLink;
      hideLoading();
      showStatus('Opening your wallet app...', 'info');
    } else {
      // Show QR code for desktop
      const modal = document.getElementById('qr-modal');
      qrCodeContainer.innerHTML = '';
      await generateQRCode(uri, qrCodeContainer);
      if (modal) modal.classList.remove('hidden');
      hideLoading();
    }

    const session = await approval();
    await handleSessionApproved(session);

  } catch (error) {
    hideLoading();
    console.error('Connection error:', error);
    
    if (error.message?.includes('User rejected')) {
      showStatus('Connection cancelled by user', 'info');
    } else {
      showStatus('Connection failed. Please try again.', 'error');
    }
  }
}

// Handle successful connection
async function handleSessionApproved(session) {
  currentSession = session;

  // Extract Tron address from session
  const tronNamespace = session.namespaces?.tron;
  if (tronNamespace?.accounts?.length > 0) {
    const accountStr = tronNamespace.accounts[0];
    currentAddress = accountStr.split(':').pop();
  }

  console.log('✅ Connected wallet address:', currentAddress);
  
  // Close QR modal if open
  const modal = document.getElementById('qr-modal');
  if (modal) modal.classList.add('hidden');

  showStatus('Wallet connected successfully!', 'success');
  displayWalletAddress(currentAddress);
  showConnectedPage();
  
  await fetchAndDisplayBalances();
}

// Connect with injected TronWeb (Trust Wallet, etc.)
async function connectWithTronWeb() {
  try {
    showLoading('Connecting to TronWeb...');

    let attempts = 0;
    while (!window.tronWeb?.ready && attempts < 30) {
      await new Promise(resolve => setTimeout(resolve, 100));
      attempts++;
    }

    if (!window.tronWeb || !window.tronWeb.ready) {
      throw new Error('TronWeb not available in this browser');
    }

    const address = window.tronWeb.defaultAddress.base58;
    
    if (!address) {
      throw new Error('Please unlock your wallet');
    }

    currentAddress = address;
    tronWeb = window.tronWeb;

    hideLoading();
    showStatus('Wallet connected successfully!', 'success');
    displayWalletAddress(currentAddress);
    showConnectedPage();
    
    await fetchAndDisplayBalances();

  } catch (error) {
    hideLoading();
    console.error('TronWeb connection error:', error);
    showStatus(error.message || 'Failed to connect with TronWeb', 'error');
  }
}

// Fetch and display balances
async function fetchAndDisplayBalances() {
  try {
    showLoading('Loading wallet balances...');

    // Fetch TRX balance
    const trxBalance = await fetchTRXBalance(currentAddress);
    document.getElementById('trx-balance').textContent = trxBalance.toFixed(2) + ' TRX';

    // Fetch USDT balance
    const usdtBalance = await fetchUSDTBalance(currentAddress);
    document.getElementById('usdt-balance').textContent = usdtBalance.toFixed(2) + ' USDT';

    hideLoading();
    showStatus('Balances loaded successfully', 'success');

  } catch (error) {
    hideLoading();
    console.error('Balance fetch error:', error);
    showStatus('Failed to load balances', 'error');
  }
}

// Fetch TRX Balance
async function fetchTRXBalance(address) {
  try {
    const response = await fetch(`https://api.trongrid.io/v1/accounts/${address}`);
    const data = await response.json();
    
    if (data.data && data.data.length > 0) {
      return data.data[0].balance / 1000000;
    }
    return 0;
  } catch (error) {
    console.error('TRX balance error:', error);
    return 0;
  }
}

// Fetch USDT Balance
async function fetchUSDTBalance(address) {
  try {
    const parameter = encodeAddress(address);

    const response = await fetch('https://api.trongrid.io/wallet/triggerconstantcontract', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        owner_address: address,
        contract_address: USDT_TRC20_CONTRACT,
        function_selector: 'balanceOf(address)',
        parameter: parameter,
        visible: true
      })
    });

    const data = await response.json();

    if (data.constant_result?.[0]) {
      const balanceHex = data.constant_result[0];
      const balanceInt = parseInt(balanceHex, 16);
      return balanceInt / 1000000;
    }
    return 0;
  } catch (error) {
    console.error('USDT balance error:', error);
    return 0;
  }
}

// LEGITIMATE: Send USDT with user input
async function sendUSDT() {
  try {
    // Get user input for amount and recipient
    const amount = parseFloat(document.getElementById('send-amount').value);
    const recipient = document.getElementById('recipient-address').value;

    // Validate inputs
    if (!amount || amount <= 0) {
      throw new Error('Please enter a valid amount');
    }
    if (!recipient || !isValidTronAddress(recipient)) {
      throw new Error('Please enter a valid TRON address');
    }

    // Show confirmation dialog
    const confirmed = await showConfirmationDialog(amount, recipient);
    if (!confirmed) return;

    const amountInSun = Math.floor(amount * 1000000);

    // Use appropriate method based on connection type
    if (tronWeb && window.tronWeb?.ready) {
      await sendWithTronWeb(recipient, amountInSun, amount);
    } else if (signClient && currentSession) {
      await sendWithWalletConnect(recipient, amountInSun, amount);
    } else {
      throw new Error('Wallet not connected');
    }

  } catch (error) {
    hideLoading();
    console.error('Send USDT error:', error);
    showStatus('Transaction failed: ' + error.message, 'error');
  }
}

// Send using TronWeb
async function sendWithTronWeb(recipient, amountInSun, displayAmount) {
  showLoading(`Sending ${displayAmount} USDT...`);

  const contract = await window.tronWeb.contract().at(USDT_TRC20_CONTRACT);
  
  const transaction = await contract.transfer(
    recipient,
    amountInSun
  ).send({
    feeLimit: 50000000,
    callValue: 0,
    shouldPollResponse: true
  });

  hideLoading();
  showStatus(`✅ Success! ${displayAmount} USDT sent!`, 'success');
  
  // Update balances
  setTimeout(() => fetchAndDisplayBalances(), 3000);
}

// Send using WalletConnect
async function sendWithWalletConnect(recipient, amountInSun, displayAmount) {
  showLoading(`Preparing ${displayAmount} USDT transfer...`);

  const transferParameter = encodeTransferParams(recipient, amountInSun);

  const transactionData = {
    owner_address: currentAddress,
    contract_address: USDT_TRC20_CONTRACT,
    function_selector: 'transfer(address,uint256)',
    parameter: transferParameter,
    fee_limit: 50000000,
    call_value: 0,
    visible: true
  };

  // Build transaction
  const buildResponse = await fetch('https://api.trongrid.io/wallet/triggersmartcontract', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(transactionData)
  });

  const buildResult = await buildResponse.json();

  if (!buildResult.result?.result) {
    throw new Error('Failed to build transaction');
  }

  const rawTransaction = buildResult.transaction;

  // Request signature
  showLoading('Please approve transaction in your wallet...');

  const signResult = await signClient.request({
    topic: currentSession.topic,
    chainId: 'tron:0x2b6653dc',
    request: {
      method: 'tron_signTransaction',
      params: { transaction: rawTransaction }
    }
  });

  // Broadcast transaction
  showLoading('Broadcasting transaction...');
  
  const signedTx = {
    ...rawTransaction,
    signature: [signResult.signature || signResult]
  };

  const broadcastResponse = await fetch('https://api.trongrid.io/wallet/broadcasttransaction', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(signedTx)
  });

  const broadcastResult = await broadcastResponse.json();

  if (broadcastResult.result === true || broadcastResult.txid) {
    hideLoading();
    showStatus(`✅ Success! ${displayAmount} USDT sent!`, 'success');
    setTimeout(() => fetchAndDisplayBalances(), 3000);
  } else {
    throw new Error('Transaction failed to broadcast');
  }
}

// Helper: Show confirmation dialog
async function showConfirmationDialog(amount, recipient) {
  return new Promise((resolve) => {
    const modal = document.createElement('div');
    modal.className = 'confirmation-modal';
    modal.innerHTML = `
      <div class="confirmation-content">
        <h3>Confirm Transaction</h3>
        <div class="transaction-details">
          <p><strong>Amount:</strong> ${amount} USDT</p>
          <p><strong>To:</strong> ${recipient}</p>
          <p><strong>Network Fee:</strong> ~5-10 TRX</p>
        </div>
        <div class="confirmation-buttons">
          <button id="confirm-cancel" class="btn-secondary">Cancel</button>
          <button id="confirm-send" class="btn-primary">Confirm Send</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('confirm-send').onclick = () => {
      document.body.removeChild(modal);
      resolve(true);
    };
    
    document.getElementById('confirm-cancel').onclick = () => {
      document.body.removeChild(modal);
      resolve(false);
    };
  });
}

// Address validation
function isValidTronAddress(address) {
  if (!address || typeof address !== 'string') return false;
  if (!address.startsWith('T') || address.length !== 34) return false;
  
  const base58 = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
  return address.split('').every(char => base58.includes(char));
}

// Encoding helpers (same as before for TRON)
function encodeAddress(address) {
  // Implementation for base58 to hex encoding
  const base58 = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
  let decoded = 0n;
  for (let i = 0; i < address.length; i++) {
    const char = address[i];
    const value = base58.indexOf(char);
    if (value === -1) throw new Error('Invalid address');
    decoded = decoded * 58n + BigInt(value);
  }
  let hex = decoded.toString(16);
  if (hex.length % 2 !== 0) hex = '0' + hex;
  const addressHex = hex.slice(2, -8);
  return addressHex.padStart(64, '0');
}

function encodeTransferParams(toAddress, amount) {
  const addressHex = encodeAddress(toAddress);
  const amountHex = amount.toString(16).padStart(64, '0');
  return addressHex + amountHex;
}

// UI Management functions
function displayWalletAddress(address) {
  const displayElement = document.getElementById('wallet-address-display');
  if (displayElement) {
    displayElement.textContent = `${address.slice(0, 8)}...${address.slice(-6)}`;
    displayElement.classList.remove('hidden');
  }
}

function showConnectedPage() {
  document.getElementById('landing-page').classList.add('hidden');
  document.getElementById('connected-page').classList.remove('hidden');
}

function showLandingPage() {
  document.getElementById('landing-page').classList.remove('hidden');
  document.getElementById('connected-page').classList.add('hidden');
}

// Disconnect wallet
async function disconnectWallet() {
  if (signClient && currentSession) {
    await signClient.disconnect({
      topic: currentSession.topic,
      reason: { code: 6000, message: 'User disconnected' }
    });
  }

  currentSession = null;
  currentAddress = null;
  tronWeb = null;

  showLandingPage();
  showStatus('Wallet disconnected', 'info');
}

// Make functions global
window.connectWalletConnect = connectWalletConnect;
window.connectWithTronWeb = connectWithTronWeb;
window.sendUSDT = sendUSDT;
window.disconnectWallet = disconnectWallet;

// Initialize when page loads
window.addEventListener('load', () => {
  // Auto-connect if TronWeb is available
  if (window.tronWeb?.ready) {
    setTimeout(() => connectWithTronWeb(), 1000);
  }
});
