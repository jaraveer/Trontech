<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TronTech — TRC20 Approve (Mainnet)</title>
  <meta name="description" content="TronTech TRC20 approve demo for Trust Wallet on TRON mainnet" />
  <style>
    :root {
      --bg: #071226;
      --card: #071a2a;
      --muted: #9aa4b2;
      --accent: #00d1b2;
      --glass: rgba(255,255,255,0.03);
      --error: #ff3860;
      --success: #23d160;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color: #e6eef6;
      background: linear-gradient(180deg, #071226, #031124);
    }
    
    .container {
      max-width: 520px;
      margin: 22px auto;
      padding: 14px;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .logo {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background: linear-gradient(135deg, #00bfa6, #0066ff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
    }
    
    h1 {
      margin: 0;
      font-size: 16px;
    }
    
    .sub {
      font-size: 12px;
      color: var(--muted);
    }
    
    .card {
      background: var(--card);
      padding: 16px;
      border-radius: 12px;
      margin-top: 14px;
      box-shadow: 0 8px 30px rgba(2, 6, 23, 0.6);
    }
    
    .row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .balance {
      font-size: 18px;
      font-weight: 700;
    }
    
    .small {
      font-size: 12px;
      color: var(--muted);
    }
    
    button {
      border: 0;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: linear-gradient(90deg, var(--accent), #0066ff);
      color: #021019;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 209, 178, 0.3);
    }
    
    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.06);
      color: var(--muted);
    }
    
    .btn-ghost:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.05);
    }
    
    input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.2);
      color: inherit;
      margin-top: 8px;
      box-sizing: border-box;
    }
    
    input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .field {
      margin-top: 16px;
    }
    
    .log {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.02);
      font-size: 13px;
      color: var(--muted);
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
    }
    
    .status {
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
    }
    
    .status-idle {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .status-loading {
      background: rgba(0, 209, 178, 0.1);
      color: var(--accent);
    }
    
    .status-success {
      background: rgba(35, 209, 96, 0.1);
      color: var(--success);
    }
    
    .status-error {
      background: rgba(255, 56, 96, 0.1);
      color: var(--error);
    }
    
    .loading-spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 6px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-message {
      color: var(--error);
      font-size: 12px;
      margin-top: 4px;
    }
    
    .success-message {
      color: var(--success);
      font-size: 12px;
      margin-top: 4px;
    }
    
    .footer {
      margin-top: 12px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
    }
    
    .wallet-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 16px;
    }
    
    .wallet-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      text-align: left;
    }
    
    .wallet-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--accent);
    }
    
    .wallet-icon {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      background: linear-gradient(135deg, #00bfa6, #0066ff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    
    .hidden {
      display: none;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(7, 18, 38, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      max-width: 300px;
      width: 90%;
    }
    
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: var(--muted);
      font-size: 18px;
      cursor: pointer;
    }
    
    .qr-code {
      margin: 15px 0;
      padding: 10px;
      background: white;
      border-radius: 8px;
      display: inline-block;
    }
    
    .instructions {
      margin-top: 15px;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      font-size: 12px;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">TT</div>
        <div>
          <h1>TronTech — TRC20 Approve</h1>
          <div class="sub">TRON Mainnet • Contract: <strong>TPT4Xin2sgSvWf53jKGcZXhMGLzaqNmkLh</strong></div>
        </div>
      </div>
      <div><button id="connectBtn" class="btn-primary">Connect Wallet</button></div>
    </header>

    <div class="card">
      <div class="field">
        <div class="small">Connected Address</div>
        <div id="address" class="balance">Not connected</div>
      </div>

      <div class="field">
        <label for="spender" class="small">Spender (who will be approved)</label>
        <input id="spender" value="TPT4Xin2sgSvWf53jKGcZXhMGLzaqNmkLh" />
        <div id="spenderError" class="error-message hidden"></div>
      </div>

      <div class="field">
        <label for="amount" class="small">Amount to approve</label>
        <input id="amount" value="1000" />
        <div id="amountError" class="error-message hidden"></div>
      </div>

      <div class="field row" style="justify-content:space-between">
        <button id="approveBtn" class="btn-primary" disabled>Approve</button>
        <button id="clearBtn" class="btn-ghost">Clear Log</button>
      </div>

      <div id="status" class="status status-idle">Status: idle</div>
      <div id="log" class="log">Logs will appear here.</div>
    </div>

    <div class="footer">
      Hosted on <strong>https://trontech.shop</strong> — TRON Mainnet only.
    </div>
  </div>

  <!-- Wallet Selection Modal -->
  <div id="walletModal" class="modal hidden">
    <div class="modal-content">
      <button id="walletClose" class="modal-close">×</button>
      <h3>Choose Wallet</h3>
      <div class="wallet-options">
        <button class="wallet-btn" id="trustWalletBtn">
          <div class="wallet-icon">TW</div>
          <div>
            <div style="font-weight: bold;">Trust Wallet</div>
            <div style="font-size: 12px; color: var(--muted);">Mobile App (Recommended)</div>
          </div>
        </button>
        <button class="wallet-btn" id="tronLinkBtn">
          <div class="wallet-icon">TL</div>
          <div>
            <div style="font-weight: bold;">TronLink</div>
            <div style="font-size: 12px; color: var(--muted);">Browser Extension</div>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- Trust Wallet Connection Modal -->
  <div id="trustWalletModal" class="modal hidden">
    <div class="modal-content">
      <button id="trustWalletClose" class="modal-close">×</button>
      <h3>Connect Trust Wallet</h3>
      
      <div class="instructions">
        <strong>Method 1: Deep Link (Mobile)</strong><br>
        Click the button below to open Trust Wallet automatically
      </div>
      
      <button id="deepLinkBtn" class="btn-primary" style="width: 100%; margin: 10px 0;">
        Open in Trust Wallet
      </button>
      
      <div class="instructions">
        <strong>Method 2: Manual Connection</strong><br>
        1. Open Trust Wallet app<br>
        2. Go to Browser<br>
        3. Navigate to this URL:<br>
        <code style="background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; margin-top: 5px; display: inline-block;">
          https://trontech.shop
        </code>
      </div>
    </div>
  </div>

  <!-- TronWeb Library -->
  <script src="https://unpkg.com/tronweb/dist/TronWeb.js"></script>
  <script>
    // Constants
    const TOKEN_CONTRACT = "TPT4Xin2sgSvWf53jKGcZXhMGLzaqNmkLh";
    const MAINNET_NODE = "https://api.trongrid.io";

    // State variables
    let tronWeb = null;
    let isConnected = false;
    let isApproving = false;

    // DOM elements
    const connectBtn = document.getElementById("connectBtn");
    const addressEl = document.getElementById("address");
    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");
    const approveBtn = document.getElementById("approveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const spenderInput = document.getElementById("spender");
    const amountInput = document.getElementById("amount");
    const spenderError = document.getElementById("spenderError");
    const amountError = document.getElementById("amountError");
    const walletModal = document.getElementById("walletModal");
    const walletClose = document.getElementById("walletClose");
    const trustWalletBtn = document.getElementById("trustWalletBtn");
    const tronLinkBtn = document.getElementById("tronLinkBtn");
    const trustWalletModal = document.getElementById("trustWalletModal");
    const trustWalletClose = document.getElementById("trustWalletClose");
    const deepLinkBtn = document.getElementById("deepLinkBtn");

    // Utility functions
    function log(msg) {
      const t = new Date().toLocaleTimeString();
      logEl.innerText = `[${t}] ${msg}\n` + logEl.innerText;
    }

    function setStatus(status, type = "idle") {
      statusEl.className = `status status-${type}`;
      statusEl.innerHTML = type === "loading" 
        ? `<span class="loading-spinner"></span>${status}`
        : status;
    }

    function showError(element, message) {
      element.textContent = message;
      element.classList.remove("hidden");
    }

    function hideError(element) {
      element.textContent = "";
      element.classList.add("hidden");
    }

    function validateInputs() {
      let isValid = true;
      
      // Validate spender address
      const spender = spenderInput.value.trim();
      if (!spender || spender.length !== 34 || !spender.startsWith("T")) {
        showError(spenderError, "Invalid TRON address format");
        isValid = false;
      } else {
        hideError(spenderError);
      }
      
      // Validate amount
      const amount = amountInput.value.trim();
      if (!amount || isNaN(amount) || Number(amount) <= 0) {
        showError(amountError, "Amount must be a positive number");
        isValid = false;
      } else {
        hideError(amountError);
      }
      
      return isValid;
    }

    function updateUI() {
      if (isConnected && tronWeb && tronWeb.defaultAddress && tronWeb.defaultAddress.base58) {
        connectBtn.textContent = "Disconnect";
        approveBtn.disabled = isApproving || !validateInputs();
      } else {
        connectBtn.textContent = "Connect Wallet";
        approveBtn.disabled = true;
      }
    }

    // Initialize TronWeb with public node
    async function initTronWeb() {
      try {
        log("Initializing TronWeb...");
        
        if (typeof TronWeb === 'undefined') {
          throw new Error('TronWeb library not loaded');
        }

        // Create TronWeb instance
        tronWeb = new TronWeb({
          fullHost: MAINNET_NODE
        });

        // Test connection
        await tronWeb.trx.getCurrentBlock();
        log("✓ TronWeb initialized successfully");
        return true;
      } catch (error) {
        log(`✗ TronWeb initialization failed: ${error.message}`);
        return false;
      }
    }

    // Connect to Trust Wallet
    async function connectTrustWallet() {
      try {
        walletModal.classList.add("hidden");
        trustWalletModal.classList.remove("hidden");
        
        // Initialize TronWeb first
        await initTronWeb();
        
        log("Ready for Trust Wallet connection");
        setStatus("Ready to connect Trust Wallet", "loading");
        
      } catch (error) {
        log(`Trust Wallet setup error: ${error.message}`);
        setStatus("Setup failed", "error");
      }
    }

    // Connect to TronLink
    async function connectTronLink() {
      try {
        setStatus("Connecting to TronLink...", "loading");
        walletModal.classList.add("hidden");

        if (window.tronLink && window.tronLink.tronWeb) {
          log("✓ TronLink detected");
          
          const tronLinkTronWeb = window.tronLink.tronWeb;
          
          // Request account access
          const result = await tronLinkTronWeb.request({ method: 'tron_requestAccounts' });
          
          if (result.code === 200) {
            tronWeb = tronLinkTronWeb;
            isConnected = true;
            
            const address = tronWeb.defaultAddress.base58;
            addressEl.textContent = address;
            
            log(`✓ Connected to TronLink: ${address}`);
            setStatus("Connected to TronLink", "success");
            updateUI();
            
          } else {
            throw new Error("User denied account access");
          }
        } else {
          throw new Error("TronLink not detected");
        }
      } catch (error) {
        log(`✗ TronLink connection failed: ${error.message}`);
        setStatus("TronLink connection failed", "error");
      }
    }

    // Check for existing TronLink connection
    function checkExistingConnection() {
      if (window.tronLink && window.tronLink.tronWeb && window.tronLink.tronWeb.defaultAddress) {
        const address = window.tronLink.tronWeb.defaultAddress.base58;
        if (address) {
          tronWeb = window.tronLink.tronWeb;
          isConnected = true;
          addressEl.textContent = address;
          setStatus("Connected to TronLink", "success");
          log(`✓ Reconnected to TronLink: ${address}`);
          updateUI();
          return true;
        }
      }
      
      // Check if we're in Trust Wallet browser
      if (isTrustWalletBrowser()) {
        log("Detected Trust Wallet browser");
        setStatus("Open in Trust Wallet browser to connect", "loading");
      }
      
      return false;
    }

    // Check if user is in Trust Wallet browser
    function isTrustWalletBrowser() {
      const userAgent = navigator.userAgent || '';
      return /TrustWallet/i.test(userAgent) || 
             window.ethereum?.isTrust || 
             window.trustWallet;
    }

    // Handle Trust Wallet connection via injected provider
    async function handleTrustWalletInjection() {
      try {
        // Trust Wallet injects a TronWeb instance when in its browser
        if (window.tronWeb && window.tronWeb.defaultAddress) {
          tronWeb = window.tronWeb;
          isConnected = true;
          
          const address = tronWeb.defaultAddress.base58;
          addressEl.textContent = address;
          
          log(`✓ Connected to Trust Wallet: ${address}`);
          setStatus("Connected to Trust Wallet", "success");
          updateUI();
          
          trustWalletModal.classList.add("hidden");
          return true;
        }
        return false;
      } catch (error) {
        log(`Trust Wallet injection error: ${error.message}`);
        return false;
      }
    }

    // Token amount conversion
    async function toTokenBase(amountHuman) {
      try {
        if (!tronWeb) {
          throw new Error('TronWeb not initialized');
        }
        
        const contract = await tronWeb.contract().at(TOKEN_CONTRACT);
        const decimals = await contract.decimals().call();
        const decimalsStr = decimals.toString();
        const factor = BigInt(10) ** BigInt(decimalsStr);
        
        const parts = String(amountHuman).split(".");
        let whole = BigInt(parts[0] || "0");
        let frac = parts[1] || "";
        
        if (frac.length > Number(decimalsStr)) {
          frac = frac.slice(0, Number(decimalsStr));
        }
        
        while (frac.length < Number(decimalsStr)) {
          frac += "0";
        }
        
        const fracBig = BigInt(frac || "0");
        return (whole * factor) + fracBig;
      } catch (error) {
        log("Error converting amount: " + error.message);
        // Fallback: assume 6 decimals
        return BigInt(Math.floor(Number(amountHuman) * 1e6));
      }
    }

    // Transaction building
    async function buildApproveTx(from, spender, amountBase) {
      try {
        if (!tronWeb) {
          throw new Error('TronWeb not initialized');
        }
        
        log(`Building approve transaction: ${from} -> ${spender}`);
        
        const tx = await tronWeb.transactionBuilder.triggerSmartContract(
          TOKEN_CONTRACT,
          "approve(address,uint256)",
          { feeLimit: 1_000_000 },
          [
            { type: "address", value: spender },
            { type: "uint256", value: amountBase.toString() }
          ],
          from
        );
        
        if (tx && tx.result && tx.result.result) {
          log("✓ Transaction built successfully");
          return tx.transaction;
        }
        
        throw new Error("Transaction building failed: " + JSON.stringify(tx));
      } catch (error) {
        log("Transaction building error: " + error.message);
        throw error;
      }
    }

    // Approval flow
    async function approveFlow() {
      if (!tronWeb || !isConnected) {
        setStatus("Wallet not connected", "error");
        return;
      }
      
      if (!tronWeb.defaultAddress || !tronWeb.defaultAddress.base58) {
        setStatus("Wallet not properly connected", "error");
        return;
      }
      
      if (!validateInputs()) {
        setStatus("Invalid inputs", "error");
        return;
      }
      
      isApproving = true;
      updateUI();
      
      try {
        const from = tronWeb.defaultAddress.base58;
        const spender = spenderInput.value.trim();
        const amountHuman = amountInput.value.trim();
        
        setStatus("Converting amount...", "loading");
        const amountBase = await toTokenBase(amountHuman);
        log(`Approving ${amountHuman} tokens to ${spender}`);
        
        setStatus("Building transaction...", "loading");
        const rawTx = await buildApproveTx(from, spender, amountBase);
        
        setStatus("Requesting signature...", "loading");
        log("Signing transaction...");
        
        const signed = await tronWeb.trx.sign(rawTx);
        
        log("✓ Transaction signed, broadcasting...");
        setStatus("Broadcasting transaction...", "loading");
        
        const result = await tronWeb.trx.sendRawTransaction(signed);
        
        if (result.result) {
          const link = `https://tronscan.org/#/transaction/${result.txid}`;
          setStatus(`Transaction successful!`, "success");
          log(`✓ Transaction successful! View on TronScan: ${link}`);
          log(`Transaction ID: ${result.txid}`);
        } else {
          throw new Error("Transaction failed: " + JSON.stringify(result));
        }
      } catch (error) {
        log("✗ Approval error: " + (error.message || error));
        setStatus("Approval failed: " + error.message, "error");
      } finally {
        isApproving = false;
        updateUI();
      }
    }

    // Disconnect wallet
    function disconnectWallet() {
      tronWeb = null;
      isConnected = false;
      addressEl.textContent = "Not connected";
      setStatus("Disconnected", "idle");
      log("Disconnected from wallet");
      updateUI();
    }

    // Show wallet modal
    function showWalletModal() {
      walletModal.classList.remove("hidden");
    }

    // Event listeners
    connectBtn.addEventListener("click", () => {
      if (isConnected) {
        disconnectWallet();
      } else {
        showWalletModal();
      }
    });
    
    approveBtn.addEventListener("click", approveFlow);
    clearBtn.addEventListener("click", () => {
      logEl.textContent = "";
      setStatus("idle", "idle");
    });
    
    walletClose.addEventListener("click", () => {
      walletModal.classList.add("hidden");
    });
    
    trustWalletClose.addEventListener("click", () => {
      trustWalletModal.classList.add("hidden");
    });
    
    trustWalletBtn.addEventListener("click", connectTrustWallet);
    tronLinkBtn.addEventListener("click", connectTronLink);
    
    // Deep link to Trust Wallet
    deepLinkBtn.addEventListener("click", () => {
      const currentUrl = encodeURIComponent(window.location.href);
      const trustWalletUrl = `https://link.trustwallet.com/open_url?coin_id=195&url=${currentUrl}`;
      
      log("Opening Trust Wallet...");
      setStatus("Opening Trust Wallet...", "loading");
      
      // Try to open Trust Wallet
      window.location.href = trustWalletUrl;
      
      // Fallback: show instructions
      setTimeout(() => {
        setStatus("Please open Trust Wallet manually", "loading");
      }, 2000);
    });
    
    // Input validation on change
    spenderInput.addEventListener("input", updateUI);
    amountInput.addEventListener("input", updateUI);
    
    // Auto-initialize on page load
    window.addEventListener('load', async () => {
      log("Page loaded. Initializing...");
      
      // Initialize TronWeb with public node
      await initTronWeb();
      
      // Check for existing connections
      setTimeout(() => {
        if (!checkExistingConnection()) {
          // Check for Trust Wallet injection
          handleTrustWalletInjection();
        }
      }, 1000);
    });

    // Listen for TronLink injection
    window.addEventListener('tronLink#initialized', () => {
      log("TronLink initialized");
      checkExistingConnection();
    });

    // Periodically check for wallet injections
    setInterval(() => {
      if (!isConnected) {
        // Check for Trust Wallet
        handleTrustWalletInjection();
        
        // Check for TronLink
        if (window.tronLink && window.tronLink.tronWeb) {
          checkExistingConnection();
        }
      }
    }, 2000);

    // Listen for page visibility changes (when returning from Trust Wallet)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && !isConnected) {
        // Page became visible again, check for wallet
        setTimeout(() => {
          handleTrustWalletInjection();
          checkExistingConnection();
        }, 500);
      }
    });
  </script>
</body>
</html>
